name: Backend CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: tbidder-backend
  REGION: us-central1
  IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/tbidder-backend

jobs:
  lint-and-check:
    name: Lint & Syntax Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci --omit=dev

      - name: Node syntax check
        run: |
          node --check src/config/index.js
          node --check src/utils/auth.js
          node --check src/config/db.js
          node --check src/routes/admin.routes.js
          node --check src/app.js
          node --check src/server.js
          node --check src/db/firestore.js
          node --check src/routes/wallet.routes.js
          node --check src/routes/auth.routes.js
          node --check src/routes/drivers.js
          node --check src/services/redis.js

      - name: Verify no hardcoded secrets
        run: |
          grep -r "admin123\|tbidder-dev-secret\|rejectUnauthorized: false\|origin: '\*'" src/ && echo "FAIL: hardcoded secret found" && exit 1 || echo "PASS: no hardcoded secrets"

  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: lint-and-check
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      image: ${{ steps.build.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build and push image
        id: build
        working-directory: backend
        run: |
          SHA=$(git rev-parse --short HEAD)
          IMAGE_TAG="${{ env.IMAGE }}:${SHA}"
          docker build -t "$IMAGE_TAG" -t "${{ env.IMAGE }}:latest" .
          docker push "$IMAGE_TAG"
          docker push "${{ env.IMAGE }}:latest"
          echo "image=${IMAGE_TAG}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ needs.build-and-push.outputs.image }}
          flags: >-
            --min-instances=1
            --max-instances=10
            --memory=512Mi
            --cpu=1
            --timeout=60
            --concurrency=80
            --no-traffic
          env_vars: |
            NODE_ENV=production
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
          secrets: |
            JWT_SECRET=jwt-secret:latest
            ADMIN_PASSWORD=admin-password:latest
            AGENCY_PASSWORD_SALT=agency-salt:latest
            DATABASE_URL=database-url:latest
            REDIS_URL=redis-url:latest

      - name: Shift 10% canary traffic
        run: |
          SHA=$(echo "${{ needs.build-and-push.outputs.image }}" | sed 's/.*://')
          NEW_REV="${{ env.SERVICE_NAME }}-${SHA}"
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --to-revisions "${NEW_REV}=10" --quiet

      - name: Health check on canary
        run: |
          ENDPOINT=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format="value(status.url)")
          sleep 10
          curl -sf "${ENDPOINT}/api/v1/health" || (echo "Health check FAILED" && exit 1)

      - name: Promote to 100% traffic
        run: |
          SHA=$(echo "${{ needs.build-and-push.outputs.image }}" | sed 's/.*://')
          NEW_REV="${{ env.SERVICE_NAME }}-${SHA}"
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --to-revisions "${NEW_REV}=100" --quiet

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed â€” rolling back to previous revision"
          PREV_REV=$(gcloud run revisions list \
            --service ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --sort-by="~metadata.creationTimestamp" \
            --limit=2 \
            --format="value(metadata.name)" | tail -1)
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --to-revisions "${PREV_REV}=100" --quiet
          echo "Rolled back to ${PREV_REV}"
