name: Backend CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'

env:
  EB_APP: tbidder-backend
  EB_ENV: tbidder-prod
  EB_REGION: ap-south-1
  EB_BUCKET: tbidder-eb-deploy-671590542848

jobs:
  lint-and-check:
    name: Lint & Syntax Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm install --omit=dev

      - name: Node syntax check
        run: |
          node --check src/config/index.js
          node --check src/utils/auth.js
          node --check src/config/db.js
          node --check src/routes/admin.routes.js
          node --check src/app.js
          node --check src/server.js
          node --check src/db/firestore.js
          node --check src/routes/wallet.routes.js
          node --check src/routes/auth.routes.js
          node --check src/routes/drivers.js
          node --check src/services/redis.js

      - name: Verify no hardcoded secrets
        run: |
          if grep -rn "admin123\|tbidder-dev-secret" src/; then
            echo "FAIL: hardcoded secret found"
            exit 1
          fi
          echo "PASS: no hardcoded secrets"

  deploy:
    name: Deploy to Elastic Beanstalk
    runs-on: ubuntu-latest
    needs: lint-and-check
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.EB_REGION }}

      - name: Package backend for EB
        run: |
          SHA=$(git rev-parse --short HEAD)-$(date +%s)
          cd backend
          zip -r "../tbidder-${SHA}.zip" . \
            --exclude "node_modules/*" \
            --exclude ".env" \
            --exclude "*.log"
          echo "VERSION=tbidder-${SHA}" >> $GITHUB_ENV
          echo "ZIPFILE=tbidder-${SHA}.zip" >> $GITHUB_ENV

      - name: Upload to S3
        run: |
          aws s3 cp "$ZIPFILE" "s3://${{ env.EB_BUCKET }}/$ZIPFILE"

      - name: Create EB application version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name "${{ env.EB_APP }}" \
            --version-label "$VERSION" \
            --source-bundle "S3Bucket=${{ env.EB_BUCKET }},S3Key=$ZIPFILE" \
            --region "${{ env.EB_REGION }}"

      - name: Deploy to EB environment
        run: |
          aws elasticbeanstalk update-environment \
            --environment-name "${{ env.EB_ENV }}" \
            --version-label "$VERSION" \
            --region "${{ env.EB_REGION }}"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for environment to be Ready..."
          for i in $(seq 1 24); do
            STATUS=$(aws elasticbeanstalk describe-environments \
              --environment-names "${{ env.EB_ENV }}" \
              --region "${{ env.EB_REGION }}" \
              --query "Environments[0].Status" --output text)
            echo "  Status: $STATUS"
            if [ "$STATUS" = "Ready" ]; then
              echo "Environment is Ready."
              break
            fi
            sleep 15
          done

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install backend dependencies
        run: npm install --omit=dev
        working-directory: backend

      - name: Run database migrations
        run: npm run migrate
        working-directory: backend
        continue-on-error: true
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Health check
        continue-on-error: true
        run: |
          sleep 10
          curl -sf "https://api.transportbidder.com/api/v1/health" \
            || curl -sf "http://${{ env.EB_ENV }}.eba-tyxfmwej.${{ env.EB_REGION }}.elasticbeanstalk.com/api/v1/health" \
            || echo "Health check could not reach server (deployment still in progress)"
          echo "Health check step done"
