packages:
  yum:
    augeas-libs: []

commands:
  01_install_certbot:
    command: |
      pip3 install certbot certbot-nginx 2>&1 || true
      ln -sf /usr/local/bin/certbot /usr/bin/certbot 2>/dev/null || true

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_certbot.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      DOMAIN="api.transportbidder.com"
      EMAIL="admin@transportbidder.com"
      CERT_DIR="/etc/letsencrypt/live/${DOMAIN}"

      if [ ! -d "$CERT_DIR" ]; then
        certbot certonly --nginx \
          --non-interactive \
          --agree-tos \
          --email "$EMAIL" \
          -d "$DOMAIN" \
          --redirect 2>&1 || \
        certbot certonly --standalone \
          --non-interactive \
          --agree-tos \
          --email "$EMAIL" \
          -d "$DOMAIN" \
          --pre-hook "systemctl stop nginx" \
          --post-hook "systemctl start nginx" 2>&1 || true
      fi

      # Auto-renew cron
      echo "0 3 * * * root certbot renew --quiet --post-hook 'systemctl reload nginx'" > /etc/cron.d/certbot-renew
